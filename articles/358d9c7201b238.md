---
title: "changesetsを使ってWebサイトのバージョンを自動管理する"
emoji: "🍇"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["githubactions", "github", "changesets"]
published: false
---

# はじめに

Web サイトのバージョン管理に[changesets](https://github.com/changesets/changesets)を導入してみて、使えると結構便利なのですが、ドキュメントがわかりにくく、使い方やつまった点など書いていこうと思います。
[changesets](https://github.com/changesets/changesets)には`npm`への公開機能などもあり、[Chakra UI](https://v2.chakra-ui.com/getting-started)や[Yamada UI](https://yamada-ui.com/ja/getting-started)でも使っていたりするのですが、今回はこの機能については記載しません。

よく比較されるツールで[semantic-release](https://semantic-release.gitbook.io/semantic-release)というものもあるのですが、こちらはコミットごとにバージョンが上がっていくようです。
自分は適当にコミットすることも多いため、より柔軟にバージョンの操作ができる[changesets](https://github.com/changesets/changesets)のほうを使っています。

# [changesets](https://github.com/changesets/changesets)とは

[changesets](https://github.com/changesets/changesets)は[セマンティックバージョニング](https://semver.org/lang/ja/)に基づいたバージョン管理を効率化できるツールです。
ざっくり、以下のような機能があります。
前の章でも言及しましたが、好きなタイミングで変更のログを書き込むことができ、リリースノートの作成なども github action 設定すれば自動でやってくれるのでめっちゃ便利です。

- 変更ログの管理
  - どのレベル（major, minor, patch）の変更にするかも都度選択可能
  - コミットや PR との紐づけもしてくれる

- リリースノートの自動作成
  - コマンドでの作成も可能
  - GitHub Action もあり、リリースの PR を自動でつくってくれる

こんな感じで作ってくれます。
![pr sample](/images/358d9c7201b238/pr-sample.png)

# 準備

公式のドキュメントはこちらになります。

:::details intro-to-using-changesets.md
https://github.com/changesets/changesets/blob/main/docs/intro-to-using-changesets.md
:::

## インストールと初期化

cli ツールは`@changesets/cli`に入っているので、これをインストールします。
公式ドキュメントだとそのままインストールしていますが、`devDependencies`の方に入れればいいと思います。

```shell
npm install --save-dev @changesets/cli
```

cli ツールを入れたら、まず初期化します。
これにより、ルートフォルダに`.changeset`フォルダが作成されます。

```shell
npx changeset init
```

## `package.json`の設定

:::details versioning-apps.md
https://github.com/changesets/changesets/blob/main/docs/versioning-apps.md
:::

[changesets](https://github.com/changesets/changesets)でバージョン管理するために`package.json`内に最低限、以下の3項目が含まれる必要があります。逆に、この3項目が含まれる`package.json`さえ作成すれば、どんなプロジェクトでもバージョン管理可能なようです。

```json
{
  "name": "package",
  "version": "1.0.0",
  "private": true
}
```

`name`にはパッケージ名を指定します。[changesets](https://github.com/changesets/changesets)は`version`の値を元にバージョンをあげていきます。
`o.o.o`から始めたい場合は、ここを書き換えるとそこからバージョンを上げれます。
`private`は`false`の場合、`npm`などに公開するためのスクリプトが走ります。今回は公開しないので、`true`にします。

## `config.json`の設定

`npx changeset init`を実行すると、`.changeset/config.json`が作成されます。
プログラムを公開しない場合は、以下の設定を追加する必要があります。

```json:.changeset/config.json
{
  ...
  "privatePackages": {
    "version": true,
    "tag": true
  }
}
```

# 使い方

[changesets](https://github.com/changesets/changesets)のコマンドで、変更の記録が記載されたファイルを生成することができ、そのファイルを含めてコミットすることで、コミットおよびそれが含まれるPRと合わせて管理できます。
記録された変更を元に、`CHANGELOG.md`ファイルにリリースノートを吐き出すことが可能です。

## 変更を記録する

変更を書き込む場合は、以下のコマンドを実行します。

```shell
npx changeset
```

実行すると、以下のようにどのレベルのバージョン変更をしたのか聞かれます。

```shell
🦋  What kind of change is this for changeset-zenn? (current version is 0.1.0) …
❯ patch
  minor
  major
```

選択すると、変更内容を聞かれるので、入力します。

```shell
🦋  What kind of change is this for changeset-zenn? (current version is 0.1.0) · patch
🦋  Please enter a summary for this change (this will be in the changelogs).
🦋    (submit empty line to open external editor)
🦋  Summary ›
```

入力して`Enter`を押下すると、これでいいですか？と聞かれるので再度`Enter`を押下して、変更の記録が記載されたファイルの生成は完了になります。

```shell
🦋  === Summary of changesets ===
🦋  patch:  changeset-zenn
🦋
🦋  Is this your desired changeset? (Y/n) › true
```

完了すると、`.changeset`フォルダ配下に先ほどの変更が記録されたmdファイルが作成されます。変更の記録を追加するたびに、このファイルは増えていきます。
mdファイルなので、バージョン変更のレベルの変更や、変更内容の文章を更新したい場合は直接変更可能です。
このファイルをコミットに含め、変更の記録は完了になります。

![changeset folder](/images/358d9c7201b238/changeset-folder.png)

## バージョンアップ

リリースのタイミングで、溜まった変更の記録を元に`CHANGELOG.md`ファイルを生成します。
以下のコマンドを実行します。

```shell
npx changeset version
```

実行すると、今まで溜まっていた`.changeset`配下のmdファイルが削除され、`CHANGELOG.md`ファイルが更新されます。
今回は`Minor`の変更と`Patch`の変更二つ実施したので、バージョンは`0.1.0`　→ `0.2.0`に変更になりました。
`package.json`ないの`version`の項目も一緒に変更されます。

```md:CHANGELOG.md
# changeset-zenn

## 0.2.0

### Minor Changes

- 8ccbd1d: Test changelog3.

### Patch Changes

- 0903189: Test changelog2.
- 52036f3: Test changelog.
```

## GitHub Action

[changesets](https://github.com/changesets/changesets)が、[Github Action](https://github.com/changesets/action)も用意してくれており、便利すぎるので[changesets](https://github.com/changesets/changesets)を使うのであれば、絶対使うべきです。
`npx changeset version`を実行し、その変更を含めコミットした上で、PRを自動で作成してくれます。追加の変更をした場合は、それも取り込んで既存のPRを上書きします。

以下のようなワークフローで`main`ブランチにプッシュされるごとに、変更が記録されたmdファイルがあるかチェックし、あればそれをPRに反映してくれます。
コミットとPRの作成を行うので、その権限を`permissions`で付与してください。
GitHubリポジトリの設定も変更が必要です。

:::details リポジトリの設定変更

Settings　→ Actions → General → Workflow permissionsの`Allow GitHub Actions to create and approve pull requests`にチェックを入れてください。
説明に記載の通り、GitHub ActionsにPRの作成を許可する設定になります。

![github setting](/images/358d9c7201b238/github-setting.png)

:::

```yml:.github/workflows/release.yml
name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release

    permissions:
      pull-requests: write
      contents: write

    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install

      - name: Create Release Pull Request
        uses: changesets/action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

こういう感じのPRを作成してくれます。
リリースの時はこのPRをマージするだけで良くなり、手動で`npx changeset version`を実行する必要はなくなります。

https://github.com/108yen/changeset-zenn/pull/1


# おすすめの使い方


## GitHub Actionの設定



## GitHub の release を作成する

## web ページにバージョンを表示する

# 補足

# リリースノートをカスタマイズする

:::details modifying-changelog-format.md
https://github.com/changesets/changesets/blob/main/docs/modifying-changelog-format.md
:::

# ブランチの運用を考える

## base branch の設定に気を付ける

## tag を発行する
